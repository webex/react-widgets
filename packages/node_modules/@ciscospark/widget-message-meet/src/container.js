import React, {Component, PropTypes} from 'react';
import {connect} from 'react-redux';
import {bindActionCreators} from 'redux';
import classNames from 'classnames';
import autobind from 'autobind-decorator';

import {fetchCurrentUser, fetchToUser} from '@ciscospark/redux-module-user';
import {injectSpark} from '@ciscospark/react-redux-spark';
import TitleBar from '@ciscospark/react-component-title-bar';
import Notifications from '@ciscospark/react-container-notifications';
import {ConnectedMessageComponent} from '@ciscospark/widget-message';
import {ConnectedMeetComponent} from '@ciscospark/widget-meet';
import styles from './styles.css';

/**
 * MessageMeetWidget Component
 */
export class MessageMeetWidget extends Component {

  componentWillReceiveProps(nextProps) {
    const {
      user,
      spark,
      sparkState,
      toPersonEmail,
      toPersonId
    } = nextProps;

    const {
      authenticated,
      connected,
      registered
    } = sparkState;

    if (spark && connected && authenticated && registered) {
      if (!user.get(`currentUser`) && !user.getIn([`status`, `isFetchingCurrentUser`])) {
        nextProps.fetchCurrentUser(spark);
      }
      if (!user.get(`toUser`) && !user.getIn([`status`, `isFetchingToUser`])) {
        nextProps.fetchToUser({toPersonEmail, toPersonId}, spark);
      }
    }
  }

  shouldComponentUpdate(nextProps) {
    const props = this.props;

    return nextProps.sparkState.connected !== props.sparkState.connected
      || nextProps.user !== props.user
      || nextProps.conversation !== props.conversation
      || nextProps.avatar !== props.avatar
      || nextProps.indicators !== props.indicators;
  }

  @autobind
  handleEvent(name, data) {
    const {onEvent} = this.props;
    if (typeof onEvent === `function`) {
      this.props.onEvent(name, data);
    }
  }

  /**
   * Render
   *
   * @returns {Object}
   */
  render() {
    const props = this.props;
    const {
      avatar,
      spark,
      sparkState,
      user
    } = props;
    const {
      toPersonEmail,
      toPersonId
    } = this.props;

    const toUser = user.get(`toUser`);

    return (
      <div className={classNames(`widget-message-meet`, styles.widgetMessageMeet)}>
        <div className={classNames(`banner`, styles.banner)} />
        <div className={classNames(`widget-message-meet-inner`, styles.widgetMessageMeetInner)}>
          <div className={classNames(`title-bar-wrapper`, styles.titleBarWrapper)}>
            {
              toUser &&
              <TitleBar
                connectionStatus={sparkState}
                image={avatar[toUser.id]}
                name={toUser.displayName}
              />
            }
          </div>
          {
            toUser &&
            <ConnectedMeetComponent
              onEvent={this.handleEvent}
              spark={spark}
              toPersonAvatar={avatar[toUser.id]}
              toPersonId={toUser.id}
              toPersonName={toUser.displayName}
            />
          }
        </div>
        <Notifications />
      </div>
    );
  }
}

MessageMeetWidget.propTypes = {
  initialActivity: PropTypes.string, // eslint-disable-line react/no-unused-prop-types
  onEvent: PropTypes.func,
  startCall: PropTypes.bool, // eslint-disable-line react/no-unused-prop-types
  toPersonEmail: PropTypes.string,
  toPersonId: PropTypes.string
};

function mapStateToProps(state) {
  return {
    avatar: state.avatar,
    spark: state.spark.get(`spark`),
    sparkState: state.spark.get(`status`).toJS(),
    user: state.user,
    indicators: state.indicators
  };
}

export default connect(
  mapStateToProps,
  (dispatch) => bindActionCreators({
    fetchCurrentUser,
    fetchToUser
  }, dispatch)
)(injectSpark(MessageMeetWidget));
