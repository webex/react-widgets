/* eslint-env mocha */
/* eslint-disable max-nested-callbacks */
import reducer, {initialState} from './reducer';
import {
  STORE_SPACE,
  UPDATE_SPACES_STATUS,
  UPDATE_SPACE_WITH_ACTIVITY,
  UPDATE_SPACE_READ,
  REMOVE_SPACE,
  STORE_SPACES
} from './actions';

let activity, avatar, space, spaces, team, user1, user2;

describe('redux module spaces reducer', () => {
  beforeEach(() => {
    avatar = {
      objectType: 'content',
      files: {
        items: [
          {
            objectType: 'file',
            url: 'https://fileUrl',
            fileSize: 56520,
            mimeType: 'image/png',
            scr: {}
          }
        ]
      },
      contentCategory: 'images'
    };

    user1 = {
      entryEmail: 'person1@email.com',
      displayName: 'Person 1',
      emailAddress: 'person1@email.com',
      objectType: 'person',
      type: 'PERSON',
      id: 'other-userid',
      orgId: '12345678-1234-1234-1234-123456789000'
    };

    user2 = {
      entryEmail: 'person2@email.com',
      displayName: 'Person 2',
      emailAddress: 'person2@email.com',
      objectType: 'person',
      type: 'PERSON',
      id: 'this-user-id',
      orgId: '12345678-1234-1234-1234-123456789000'
    };

    team = {
      displayName: 'Test Team',
      color: '#C589C5',
      generalConversationUuid: 'spaceId',
      id: 'teamId',
      archived: false
    };

    space = {
      participants: [user1, user2],
      lastReadableActivityDate: '2017-06-07T15:13:56.326Z',
      displayName: 'Space 1',
      lastSeenActivityDate: '2017-06-07T15:13:34.505Z',
      published: '2016-02-29T17:49:17.029Z',
      url: 'https://converstaionUrl',
      activities: {
        items: [activity]
      },
      tags: [
        'MUTED',
        'FAVORITE',
        'LOCKED',
        'TEAM',
        'JOINED',
        'MESSAGE_NOTIFICATIONS_OFF',
        'MENTION_NOTIFICATIONS_ON'
      ],
      avatar,
      type: 'group',
      id: 'mySpaceId',
      team,
      conversationWebUrl: 'https://conversationWebUrl'
    };

    spaces = {
      mySpaceId: space
    };
  });

  it('should return initial state', () => {
    expect(reducer(undefined, {}))
      .toMatchSnapshot();
  });

  it('should handle STORE_SPACE', () => {
    expect(reducer(initialState, {
      type: STORE_SPACE,
      payload: {
        space
      }
    })).toMatchSnapshot();
  });

  it('should handle REMOVE_SPACE', () => {
    const addedSpaceState = initialState.mergeDeepIn(['items', space.id], space);
    expect(reducer(addedSpaceState, {
      type: REMOVE_SPACE,
      payload: {
        id: space.id
      }
    })).toMatchSnapshot();
  });

  it('should handle STORE_SPACES', () => {
    expect(reducer(initialState, {
      type: STORE_SPACES,
      payload: {
        spaces
      }
    })).toMatchSnapshot();
  });

  it('should handle UPDATE_SPACES_STATUS', () => {
    expect(reducer(initialState, {
      type: UPDATE_SPACES_STATUS,
      payload: {
        status: {
          isFetching: true,
          hasFetched: true
        }
      }
    })).toMatchSnapshot();
  });

  it('should handle UPDATE_SPACE_WITH_ACTIVITY', () => {
    const addedSpaceState = initialState.mergeDeepIn(['items', space.id], space);
    space.lastSeenActivityDate = '2017-06-17T15:13:34.505Z';
    expect(reducer(addedSpaceState, {
      type: UPDATE_SPACE_WITH_ACTIVITY,
      payload: {
        space
      }
    })).toMatchSnapshot();
  });

  it('should handle UPDATE_SPACE_READ', () => {
    const addedSpaceState = initialState.mergeDeepIn(['items', space.id], space);
    expect(reducer(addedSpaceState, {
      type: UPDATE_SPACE_READ,
      payload: {
        spaceId: space.id,
        lastSeenDate: '2017-06-17T17:11:34.505Z'
      }
    })).toMatchSnapshot();
  });
});
