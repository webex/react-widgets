import {compose, lifecycle} from 'recompose';
import {bindActionCreators} from 'redux';
import {connect} from 'react-redux';
import {storeExternalCall} from '@ciscospark/redux-module-media';

import {storeMeetDetails} from '../actions';

import {destinationTypes} from '../';

export default compose(
  connect(
    (state) => state,
    (dispatch) => bindActionCreators({
      storeExternalCall,
      storeMeetDetails
    }, dispatch)
  ),
  lifecycle({
    componentWillMount() {
      const {props} = this;
      const {
        call,
        media
      } = props;

      if (call) {
        const details = {};

        // Store call if it's not in the store
        if (call.locus && !media.hasIn(['byLocusUrl', call.locus.url])) {
          const {id} = props.storeExternalCall(call);

          details.callId = id;
        }
        if (call.locus && call.locus.conversationUrl) {
          details.toValue = call.locus.conversationUrl.split('/').pop();
          details.toType = destinationTypes.SPACEID;
          const {locusTags} = call.locus.info;

          if (locusTags && locusTags.includes('ONE_ON_ONE')) {
            const otherUser = call.memberships.filter((u) => call.me.personUuid !== u.personUuid)[0];

            details.toValue = otherUser.personUuid;
            details.toType = destinationTypes.USERID;
          }
        }
        props.storeMeetDetails(details);
      }
    }
  })
);
